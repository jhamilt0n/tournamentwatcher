<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Registration</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-input: #1a1a25;
            --accent-gold: #d4af37;
            --accent-gold-dim: #b8962e;
            --accent-green: #2ecc71;
            --accent-red: #e74c3c;
            --accent-orange: #f39c12;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a8;
            --text-muted: #606068;
            --border-color: #2a2a35;
            --border-focus: #d4af37;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Source Sans 3', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container { max-width: 800px; margin: 0 auto; padding: 20px; }

        .tournament-select-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            letter-spacing: 2px;
            color: var(--accent-gold);
            margin-bottom: 20px;
        }

        .form-group { margin-bottom: 20px; }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.15);
        }

        .form-input::placeholder { color: var(--text-muted); }

        .form-select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23a0a0a8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 44px;
        }

        .form-select option { background: var(--bg-card); color: var(--text-primary); }

        .tournament-info {
            display: none;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .tournament-info.visible { display: block; animation: fadeIn 0.4s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tournament-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            letter-spacing: 3px;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .info-item { background: var(--bg-input); padding: 15px; border-radius: 8px; }
        .info-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 5px; }
        .info-value { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
        .info-value.highlight { color: var(--accent-gold); }
        .info-value.warning { color: var(--accent-orange); }

        .rules-section { background: var(--bg-input); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .rules-title { font-weight: 700; color: var(--accent-gold); margin-bottom: 10px; }
        .rules-text { color: var(--text-secondary); white-space: pre-wrap; }

        .sponsors-section { display: flex; flex-wrap: wrap; gap: 10px; }

        .sponsor-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #1877f2;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .sponsor-link:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(24, 119, 242, 0.4); }
        .sponsor-link svg { width: 18px; height: 18px; }

        .registration-form {
            display: none;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .registration-form.visible { display: block; animation: fadeIn 0.4s ease; }

        .edit-mode-section {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px dashed var(--border-color);
        }

        .edit-mode-section.editing { border-color: var(--accent-orange); background: rgba(243, 156, 18, 0.1); }
        .edit-mode-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .edit-mode-title { font-weight: 600; color: var(--text-secondary); }

        .edit-badge {
            background: var(--accent-orange);
            color: var(--bg-dark);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .lookup-form { display: flex; gap: 10px; flex-wrap: wrap; }
        .lookup-form .form-input { flex: 1; min-width: 200px; }

        .team-info-section { margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid var(--border-color); }

        .combined-rating-display {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            display: none;
        }

        .combined-rating-display.visible { display: block; }
        .combined-rating-display.over-cap { border: 2px solid var(--accent-red); background: rgba(231, 76, 60, 0.1); }

        .rating-display-content { display: flex; justify-content: space-between; align-items: center; }
        .rating-info { display: flex; flex-direction: column; }
        .rating-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .rating-value { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: var(--accent-gold); }
        .rating-value.over-cap { color: var(--accent-red); }
        .rating-cap-info { text-align: right; }

        .cap-status { font-weight: 600; padding: 6px 14px; border-radius: 20px; font-size: 0.9rem; }
        .cap-status.under { background: rgba(46, 204, 113, 0.15); color: var(--accent-green); }
        .cap-status.over { background: rgba(231, 76, 60, 0.15); color: var(--accent-red); }

        .player-section {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .player-header {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 2px;
            color: var(--accent-gold);
            margin-bottom: 20px;
        }

        .search-container { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-input { flex: 1; }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-search { background: var(--accent-gold); color: var(--bg-dark); }
        .btn-search:hover { background: var(--accent-gold-dim); transform: translateY(-1px); }
        .btn-search:disabled { background: var(--text-muted); cursor: not-allowed; transform: none; }

        .btn-lookup { background: var(--accent-orange); color: var(--bg-dark); }
        .btn-lookup:hover { background: #e67e22; }

        .btn-clear { background: transparent; border: 2px solid var(--accent-red); color: var(--accent-red); padding: 12px 20px; }
        .btn-clear:hover { background: var(--accent-red); color: white; }

        .btn-cancel-edit { background: transparent; border: 2px solid var(--text-muted); color: var(--text-muted); padding: 12px 20px; }
        .btn-cancel-edit:hover { border-color: var(--text-secondary); color: var(--text-secondary); }

        .search-results { display: none; margin-top: 15px; }
        .search-results.visible { display: block; }

        .search-status { padding: 15px; border-radius: 8px; margin-bottom: 15px; font-weight: 500; }
        .search-status.loading { background: rgba(212, 175, 55, 0.1); color: var(--accent-gold); }
        .search-status.error { background: rgba(231, 76, 60, 0.1); color: var(--accent-red); }
        .search-status.no-results { background: rgba(160, 160, 168, 0.1); color: var(--text-secondary); }

        .results-list { display: flex; flex-direction: column; gap: 10px; }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .result-item:hover { border-color: var(--accent-gold); transform: translateX(5px); }
        .result-item.disabled { opacity: 0.5; cursor: not-allowed; }
        .result-item.disabled:hover { border-color: var(--accent-red); transform: none; }
        .result-item.would-exceed-cap { border-color: var(--accent-orange); opacity: 0.7; }
        .result-item.would-exceed-cap:hover { border-color: var(--accent-red); }

        .result-info { flex: 1; }
        .result-name { font-weight: 700; font-size: 1.1rem; margin-bottom: 3px; }
        .result-location { color: var(--text-muted); font-size: 0.9rem; }
        .result-stats { text-align: right; }
        .result-rating { font-weight: 700; font-size: 1.2rem; color: var(--accent-gold); }
        .result-rating.over-max { color: var(--accent-red); }
        .result-robustness { font-size: 0.85rem; color: var(--text-muted); }
        .result-robustness.insufficient { color: var(--accent-red); }
        .result-warning { font-size: 0.8rem; color: var(--accent-orange); margin-top: 4px; }

        .not-in-system-btn {
            width: 100%;
            padding: 15px;
            background: transparent;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 10px;
        }

        .not-in-system-btn:hover { border-color: var(--text-secondary); color: var(--text-primary); }
        .not-in-system-btn.hidden { display: none; }

        .selected-player {
            display: none;
            background: rgba(46, 204, 113, 0.1);
            border: 2px solid var(--accent-green);
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
        }

        .selected-player.visible { display: flex; justify-content: space-between; align-items: center; animation: fadeIn 0.3s ease; }
        .selected-player-info h4 { color: var(--accent-green); font-size: 1.1rem; margin-bottom: 5px; }
        .selected-player-info p { color: var(--text-secondary); font-size: 0.9rem; }

        .phone-input-wrapper { position: relative; }
        .phone-prefix { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-weight: 600; }
        .phone-input { padding-left: 50px; }
        .phone-validation { margin-top: 8px; font-size: 0.85rem; }
        .phone-validation.valid { color: var(--accent-green); }
        .phone-validation.invalid { color: var(--accent-red); }

        .submit-section { margin-top: 30px; }

        .btn-submit {
            width: 100%;
            padding: 18px 30px;
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-dim) 100%);
            color: var(--bg-dark);
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 3px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
        }

        .btn-submit:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 30px rgba(212, 175, 55, 0.4); }
        .btn-submit:disabled { background: var(--text-muted); box-shadow: none; cursor: not-allowed; }
        .btn-submit.update-mode { background: linear-gradient(135deg, var(--accent-orange) 0%, #e67e22 100%); box-shadow: 0 4px 20px rgba(243, 156, 18, 0.3); }

        .alert { padding: 20px; border-radius: 10px; margin-bottom: 20px; display: none; }
        .alert.visible { display: block; animation: fadeIn 0.3s ease; }
        .alert-success { background: rgba(46, 204, 113, 0.15); border: 1px solid var(--accent-green); color: var(--accent-green); }
        .alert-error { background: rgba(231, 76, 60, 0.15); border: 1px solid var(--accent-red); color: var(--accent-red); }

        .warning-box { background: rgba(231, 76, 60, 0.1); border: 1px solid var(--accent-red); border-radius: 8px; padding: 15px; margin-bottom: 20px; color: var(--accent-red); font-weight: 500; }
        .cap-warning-box { background: rgba(243, 156, 18, 0.1); border: 1px solid var(--accent-orange); border-radius: 8px; padding: 15px; margin-bottom: 20px; color: var(--accent-orange); font-weight: 500; }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(212, 175, 55, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-gold);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 600px) {
            .container { padding: 15px; }
            .tournament-name { font-size: 1.8rem; }
            .search-container { flex-direction: column; }
            .btn-search { width: 100%; }
            .result-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .result-stats { text-align: left; }
            .lookup-form { flex-direction: column; }
            .rating-display-content { flex-direction: column; gap: 15px; text-align: center; }
            .rating-cap-info { text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <section class="tournament-select-section">
            <h2 class="section-title">Select Tournament</h2>
            <div class="form-group">
                <label class="form-label" for="tournamentSelect">Choose a Tournament</label>
                <select class="form-select" id="tournamentSelect">
                    <option value="">-- Select a Tournament --</option>
                </select>
            </div>
        </section>

        <div id="alertSuccess" class="alert alert-success"></div>
        <div id="alertError" class="alert alert-error"></div>

        <section id="tournamentInfo" class="tournament-info">
            <h1 id="tournamentName" class="tournament-name"></h1>
            
            <div class="info-grid">
                <div class="info-item"><div class="info-label">Date</div><div class="info-value" id="infoDate"></div></div>
                <div class="info-item"><div class="info-label">Doors Open</div><div class="info-value" id="infoDoorsOpen"></div></div>
                <div class="info-item"><div class="info-label">Play Begins</div><div class="info-value" id="infoPlayBegins"></div></div>
                <div class="info-item"><div class="info-label">Location</div><div class="info-value" id="infoLocation"></div></div>
                <div class="info-item"><div class="info-label">Entry Fee</div><div class="info-value highlight" id="infoEntryFee"></div></div>
                <div class="info-item"><div class="info-label">Format</div><div class="info-value" id="infoFormat"></div></div>
                <div class="info-item"><div class="info-label">Elimination</div><div class="info-value" id="infoElimination"></div></div>
                <div class="info-item"><div class="info-label">Race To (W/L)</div><div class="info-value" id="infoRace"></div></div>
                <div class="info-item"><div class="info-label">Table Size</div><div class="info-value" id="infoTableSize"></div></div>
                <div class="info-item"><div class="info-label">Table Type</div><div class="info-value" id="infoTableType"></div></div>
                <div class="info-item"><div class="info-label">Table Fees</div><div class="info-value" id="infoTableFees"></div></div>
            </div>

            <div class="info-grid">
                <div class="info-item" id="auctionItem" style="display:none;"><div class="info-label">Player Auction</div><div class="info-value highlight">Yes</div></div>
                <div class="info-item" id="sidepotItem" style="display:none;"><div class="info-label">Sidepot</div><div class="info-value highlight">Yes</div></div>
                <div class="info-item" id="addedMoneyItem" style="display:none;"><div class="info-label">Added Money</div><div class="info-value highlight" id="infoAddedMoney"></div></div>
                <div class="info-item" id="maxPlayersItem" style="display:none;"><div class="info-label">Max Entries</div><div class="info-value" id="infoMaxPlayers"></div></div>
                <div class="info-item" id="robustnessItem" style="display:none;"><div class="info-label">Min Robustness</div><div class="info-value highlight" id="infoRobustness"></div></div>
                <div class="info-item" id="maxRatingItem" style="display:none;"><div class="info-label">Max Individual Rating</div><div class="info-value warning" id="infoMaxRating"></div></div>
                <div class="info-item" id="ratingCapItem" style="display:none;"><div class="info-label">Combined Rating Cap</div><div class="info-value warning" id="infoRatingCap"></div></div>
            </div>

            <div id="rulesSection" class="rules-section" style="display:none;">
                <div class="rules-title">Tournament Rules</div>
                <div class="rules-text" id="infoRules"></div>
            </div>

            <div id="sponsorsSection" class="sponsors-section" style="display:none;"></div>
        </section>

        <section id="registrationForm" class="registration-form">
            <h2 class="section-title">Registration</h2>

            <div id="editModeSection" class="edit-mode-section">
                <div class="edit-mode-header">
                    <span class="edit-mode-title">Already registered? Look up your registration to make changes:</span>
                    <span id="editBadge" class="edit-badge" style="display:none;">Editing</span>
                </div>
                <div class="lookup-form">
                    <input type="tel" class="form-input" id="lookupPhone" placeholder="Enter phone number used to register">
                    <button type="button" class="btn btn-lookup" id="lookupBtn">Look Up</button>
                    <button type="button" class="btn btn-cancel-edit" id="cancelEditBtn" style="display:none;">Cancel Edit</button>
                </div>
            </div>

            <div id="robustnessWarning" class="warning-box" style="display:none;">
                ⚠️ This tournament requires a minimum Fargo robustness of <span id="requiredRobustness"></span>. Players not meeting this requirement cannot register.
            </div>

            <div id="maxRatingWarning" class="warning-box" style="display:none;">
                ⚠️ This tournament has a maximum individual Fargo rating of <span id="maxRatingValue"></span>. Players above this rating cannot register.
            </div>

            <div id="ratingCapWarning" class="cap-warning-box" style="display:none;">
                ⚠️ This tournament has a combined team rating cap of <span id="ratingCapValue"></span>. Teams exceeding this cap cannot register.
            </div>

            <div id="combinedRatingDisplay" class="combined-rating-display">
                <div class="rating-display-content">
                    <div class="rating-info">
                        <span class="rating-label">Combined Team Rating</span>
                        <span id="combinedRatingValue" class="rating-value">0</span>
                    </div>
                    <div class="rating-cap-info">
                        <span id="capStatus" class="cap-status under">Under Cap</span>
                        <div style="margin-top: 5px; font-size: 0.85rem; color: var(--text-muted);">Cap: <span id="capLimit">0</span></div>
                    </div>
                </div>
            </div>

            <div id="teamInfoSection" class="team-info-section" style="display:none;">
                <div class="form-group">
                    <label class="form-label" for="teamName">Team Name</label>
                    <input type="text" class="form-input" id="teamName" placeholder="Enter your team name">
                </div>
                <div class="form-group">
                    <label class="form-label" for="captainPhone">Captain's Phone Number</label>
                    <div class="phone-input-wrapper">
                        <span class="phone-prefix">+1</span>
                        <input type="tel" class="form-input phone-input" id="captainPhone" placeholder="(555) 123-4567" maxlength="14">
                    </div>
                    <div id="captainPhoneValidation" class="phone-validation"></div>
                </div>
            </div>

            <div id="playerSections"></div>

            <div class="submit-section">
                <button type="button" class="btn btn-submit" id="submitBtn" disabled>Complete Registration</button>
            </div>
        </section>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzGWG2Tz2wlu9bKkh6VkHR4Iugh_pV8-DScTbxnD2J80KhiH7dEu_9L-RQ6LFdF8H3J2g/exec';
        const FARGO_API_URL = 'https://dashboard.fargorate.com/api/indexsearch';

        let tournaments = [];
        let selectedTournament = null;
        let playerSelections = [];
        let isEditMode = false;
        let editRowIndex = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadTournaments();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('tournamentSelect').addEventListener('change', onTournamentChange);
            document.getElementById('submitBtn').addEventListener('click', submitRegistration);
            document.getElementById('lookupBtn').addEventListener('click', lookupRegistration);
            document.getElementById('cancelEditBtn').addEventListener('click', cancelEditMode);
            document.getElementById('lookupPhone').addEventListener('input', formatPhoneInput);
        }

        function formatPhoneInput(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0) {
                if (value.length <= 3) value = `(${value}`;
                else if (value.length <= 6) value = `(${value.slice(0,3)}) ${value.slice(3)}`;
                else value = `(${value.slice(0,3)}) ${value.slice(3,6)}-${value.slice(6,10)}`;
            }
            e.target.value = value;
        }

        async function loadTournaments() {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getTournaments`);
                const data = await response.json();
                if (data.success) { tournaments = data.tournaments; populateTournamentDropdown(); }
                else showAlert('error', 'Failed to load tournaments. Please refresh the page.');
            } catch (error) {
                console.error('Error loading tournaments:', error);
                showAlert('error', 'Failed to load tournaments. Please check your connection and refresh.');
            }
        }

        function populateTournamentDropdown() {
            const select = document.getElementById('tournamentSelect');
            tournaments.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = `${t.name} - ${t.date}`;
                select.appendChild(option);
            });
        }

        function onTournamentChange(e) {
            const tournamentId = e.target.value;
            cancelEditMode();
            if (!tournamentId) { hideTournamentInfo(); return; }
            selectedTournament = tournaments.find(t => t.id === tournamentId);
            if (selectedTournament) { displayTournamentInfo(); buildRegistrationForm(); }
        }

        function displayTournamentInfo() {
            const t = selectedTournament;

            document.getElementById('tournamentName').textContent = t.name;
            document.getElementById('infoDate').textContent = t.date;
            document.getElementById('infoDoorsOpen').textContent = t.doorsOpen || 'TBD';
            document.getElementById('infoPlayBegins').textContent = t.playBegins || 'TBD';
            document.getElementById('infoLocation').textContent = t.location;
            document.getElementById('infoEntryFee').textContent = t.entryFee;
            document.getElementById('infoFormat').textContent = t.formatDescription || `${t.teamSize} Player${t.teamSize > 1 ? 's' : ''}`;
            document.getElementById('infoElimination').textContent = t.eliminationType || 'Double Elimination';
            
            // Race format: Winner/Loser
            const raceW = t.raceWinner || '?';
            const raceL = t.raceLoser || '?';
            document.getElementById('infoRace').textContent = `${raceW} / ${raceL}`;
            
            document.getElementById('infoTableSize').textContent = t.tableSize || '7ft';
            document.getElementById('infoTableType').textContent = t.tableType || 'Diamond';
            document.getElementById('infoTableFees').textContent = t.tableFees || 'Coin-op $1.50 per game';

            toggleInfoItem('auctionItem', t.playerAuction);
            toggleInfoItem('sidepotItem', t.sidepot);
            
            if (t.addedMoney) { document.getElementById('addedMoneyItem').style.display = 'block'; document.getElementById('infoAddedMoney').textContent = t.addedMoneyStructure || 'Yes'; }
            else document.getElementById('addedMoneyItem').style.display = 'none';

            if (t.maxPlayers) { document.getElementById('maxPlayersItem').style.display = 'block'; document.getElementById('infoMaxPlayers').textContent = t.maxPlayers; }
            else document.getElementById('maxPlayersItem').style.display = 'none';

            if (t.robustnessRequirement) { document.getElementById('robustnessItem').style.display = 'block'; document.getElementById('infoRobustness').textContent = t.robustnessRequirement; }
            else document.getElementById('robustnessItem').style.display = 'none';

            if (t.maxIndividualRating) { document.getElementById('maxRatingItem').style.display = 'block'; document.getElementById('infoMaxRating').textContent = t.maxIndividualRating; }
            else document.getElementById('maxRatingItem').style.display = 'none';

            if (t.ratingCap) { document.getElementById('ratingCapItem').style.display = 'block'; document.getElementById('infoRatingCap').textContent = t.ratingCap; }
            else document.getElementById('ratingCapItem').style.display = 'none';

            if (t.rules) { document.getElementById('rulesSection').style.display = 'block'; document.getElementById('infoRules').textContent = t.rules; }
            else document.getElementById('rulesSection').style.display = 'none';

            const sponsorsSection = document.getElementById('sponsorsSection');
            if (t.sponsorLinks && t.sponsorLinks.length > 0) {
                sponsorsSection.style.display = 'flex';
                sponsorsSection.innerHTML = t.sponsorLinks.map(link => {
                    const name = extractFacebookName(link);
                    return `<a href="${link}" target="_blank" class="sponsor-link"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>${name}</a>`;
                }).join('');
            } else sponsorsSection.style.display = 'none';

            document.getElementById('tournamentInfo').classList.add('visible');
        }

        function toggleInfoItem(id, show) { document.getElementById(id).style.display = show ? 'block' : 'none'; }

        function hideTournamentInfo() {
            document.getElementById('tournamentInfo').classList.remove('visible');
            document.getElementById('registrationForm').classList.remove('visible');
            selectedTournament = null;
        }

        function buildRegistrationForm() {
            const t = selectedTournament;
            playerSelections = new Array(t.teamSize).fill(null);

            // Robustness warning
            const robustnessWarningEl = document.getElementById('robustnessWarning');
            if (t.robustnessRequirement) { robustnessWarningEl.style.display = 'block'; document.getElementById('requiredRobustness').textContent = t.robustnessRequirement; }
            else robustnessWarningEl.style.display = 'none';

            // Max individual rating warning
            const maxRatingWarningEl = document.getElementById('maxRatingWarning');
            if (t.maxIndividualRating) { maxRatingWarningEl.style.display = 'block'; document.getElementById('maxRatingValue').textContent = t.maxIndividualRating; }
            else maxRatingWarningEl.style.display = 'none';

            // Combined rating cap warning and display
            const capWarningEl = document.getElementById('ratingCapWarning');
            const capDisplayEl = document.getElementById('combinedRatingDisplay');
            if (t.ratingCap && t.teamSize > 1) {
                capWarningEl.style.display = 'block';
                document.getElementById('ratingCapValue').textContent = t.ratingCap;
                capDisplayEl.classList.add('visible');
                document.getElementById('capLimit').textContent = t.ratingCap;
                updateCombinedRating();
            } else { capWarningEl.style.display = 'none'; capDisplayEl.classList.remove('visible'); }

            const teamSection = document.getElementById('teamInfoSection');
            if (t.teamSize > 1) {
                teamSection.style.display = 'block';
                document.getElementById('teamName').value = '';
                document.getElementById('captainPhone').value = '';
                document.getElementById('captainPhoneValidation').textContent = '';
                setupPhoneValidation('captainPhone', 'captainPhoneValidation');
            } else teamSection.style.display = 'none';

            const playerSectionsEl = document.getElementById('playerSections');
            playerSectionsEl.innerHTML = '';
            for (let i = 0; i < t.teamSize; i++) playerSectionsEl.appendChild(createPlayerSection(i, t.teamSize === 1));

            document.getElementById('editModeSection').classList.remove('editing');
            document.getElementById('editBadge').style.display = 'none';
            document.getElementById('cancelEditBtn').style.display = 'none';
            document.getElementById('lookupPhone').value = '';
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = 'Complete Registration';
            submitBtn.classList.remove('update-mode');

            document.getElementById('registrationForm').classList.add('visible');
            validateForm();
        }

        function createPlayerSection(index, isSingle) {
            const section = document.createElement('div');
            section.className = 'player-section';
            section.id = `playerSection${index}`;
            const title = isSingle ? 'Player Information' : `Player ${index + 1}`;
            const phoneHtml = isSingle ? `<div class="form-group" style="margin-top: 20px;"><label class="form-label" for="playerPhone${index}">Phone Number</label><div class="phone-input-wrapper"><span class="phone-prefix">+1</span><input type="tel" class="form-input phone-input" id="playerPhone${index}" placeholder="(555) 123-4567" maxlength="14"></div><div id="playerPhoneValidation${index}" class="phone-validation"></div></div>` : '';
            section.innerHTML = `<h3 class="player-header">${title}</h3><div class="search-container"><input type="text" class="form-input search-input" id="searchInput${index}" placeholder="Enter player name to search Fargo database"><button type="button" class="btn btn-search" id="searchBtn${index}">Search</button></div><div class="search-results" id="searchResults${index}"><div class="search-status" id="searchStatus${index}"></div><div class="results-list" id="resultsList${index}"></div><button type="button" class="not-in-system-btn hidden" id="notInSystemBtn${index}">Player not in Fargo system - Enter name manually</button></div><div class="selected-player" id="selectedPlayer${index}"><div class="selected-player-info"><h4 id="selectedName${index}"></h4><p id="selectedDetails${index}"></p></div><button type="button" class="btn btn-clear" id="clearBtn${index}">Change</button></div>${phoneHtml}`;
            setTimeout(() => {
                document.getElementById(`searchBtn${index}`).addEventListener('click', () => searchPlayer(index));
                document.getElementById(`searchInput${index}`).addEventListener('keypress', (e) => { if (e.key === 'Enter') searchPlayer(index); });
                document.getElementById(`clearBtn${index}`).addEventListener('click', () => clearPlayerSelection(index));
                document.getElementById(`notInSystemBtn${index}`).addEventListener('click', () => selectNotInSystem(index));
                if (isSingle) setupPhoneValidation(`playerPhone${index}`, `playerPhoneValidation${index}`);
            }, 0);
            return section;
        }

        async function searchPlayer(index) {
            const searchInput = document.getElementById(`searchInput${index}`);
            const searchResults = document.getElementById(`searchResults${index}`);
            const searchStatus = document.getElementById(`searchStatus${index}`);
            const resultsList = document.getElementById(`resultsList${index}`);
            const notInSystemBtn = document.getElementById(`notInSystemBtn${index}`);
            const searchBtn = document.getElementById(`searchBtn${index}`);
            const query = searchInput.value.trim();
            if (!query) return;
            searchResults.classList.add('visible');
            searchStatus.className = 'search-status loading';
            searchStatus.innerHTML = '<span class="spinner"></span> Searching Fargo database...';
            resultsList.innerHTML = '';
            notInSystemBtn.classList.add('hidden');
            searchBtn.disabled = true;
            try {
                const response = await fetch(`${FARGO_API_URL}?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                searchBtn.disabled = false;
                if (data.value && data.value.length > 0) { searchStatus.style.display = 'none'; displaySearchResults(index, data.value); }
                else { searchStatus.className = 'search-status no-results'; searchStatus.textContent = `No players found matching "${query}". Try a different spelling or nickname.`; if (!selectedTournament.robustnessRequirement && !selectedTournament.maxIndividualRating) notInSystemBtn.classList.remove('hidden'); }
            } catch (error) { console.error('Search error:', error); searchBtn.disabled = false; searchStatus.className = 'search-status error'; searchStatus.textContent = 'Search failed. Please try again.'; }
        }

        function displaySearchResults(index, players) {
            const resultsList = document.getElementById(`resultsList${index}`);
            const notInSystemBtn = document.getElementById(`notInSystemBtn${index}`);
            const robustnessReq = selectedTournament.robustnessRequirement;
            const maxIndividualRating = selectedTournament.maxIndividualRating;
            const ratingCap = selectedTournament.ratingCap;

            resultsList.innerHTML = players.map(player => {
                const playerRating = parseInt(player.rating) || 0;
                const playerRobustness = parseInt(player.robustness) || 0;
                
                const meetsRobustness = !robustnessReq || playerRobustness >= parseInt(robustnessReq);
                const meetsMaxRating = !maxIndividualRating || playerRating <= parseInt(maxIndividualRating);
                const robustnessClass = meetsRobustness ? '' : 'insufficient';
                const ratingClass = meetsMaxRating ? '' : 'over-max';
                
                let wouldExceedCap = false, capWarningText = '';
                if (ratingCap && selectedTournament.teamSize > 1) {
                    const potentialTotal = calculatePotentialRating(index, playerRating);
                    if (potentialTotal > parseInt(ratingCap)) { wouldExceedCap = true; capWarningText = `Would bring total to ${potentialTotal} (over ${ratingCap} cap)`; }
                }
                
                const canSelect = meetsRobustness && meetsMaxRating && !wouldExceedCap;
                let itemClass = '';
                let disableReason = '';
                if (!meetsRobustness) { itemClass = 'disabled'; disableReason = 'Does not meet robustness requirement'; }
                else if (!meetsMaxRating) { itemClass = 'disabled'; disableReason = `Rating ${playerRating} exceeds max ${maxIndividualRating}`; }
                else if (wouldExceedCap) { itemClass = 'would-exceed-cap'; disableReason = 'Would exceed rating cap'; }
                
                return `<div class="result-item ${itemClass}" onclick="${canSelect ? `selectPlayer(${index}, ${JSON.stringify(player).replace(/"/g, '&quot;')})` : ''}" title="${disableReason || 'Click to select'}"><div class="result-info"><div class="result-name">${player.firstName} ${player.lastName}</div><div class="result-location">${player.location || 'Location unknown'}</div>${wouldExceedCap ? `<div class="result-warning">⚠️ ${capWarningText}</div>` : ''}${!meetsMaxRating ? `<div class="result-warning">⚠️ Exceeds max rating of ${maxIndividualRating}</div>` : ''}</div><div class="result-stats"><div class="result-rating ${ratingClass}">${player.rating}</div><div class="result-robustness ${robustnessClass}">Robustness: ${player.robustness}</div></div></div>`;
            }).join('');

            // Show "not in system" only if no robustness or max rating requirement
            if (!robustnessReq && !maxIndividualRating) notInSystemBtn.classList.remove('hidden');
        }

        function calculatePotentialRating(changingIndex, newRating) {
            let total = 0;
            for (let i = 0; i < playerSelections.length; i++) {
                if (i === changingIndex) total += newRating;
                else if (playerSelections[i] && playerSelections[i].inSystem) total += parseInt(playerSelections[i].rating) || 0;
            }
            return total;
        }

        function selectPlayer(index, player) {
            playerSelections[index] = { fargoId: player.id, readableId: player.readableId, name: `${player.firstName} ${player.lastName}`, rating: player.rating, robustness: player.robustness, location: player.location, inSystem: true };
            document.getElementById(`searchResults${index}`).classList.remove('visible');
            document.getElementById(`selectedName${index}`).textContent = `✓ ${player.firstName} ${player.lastName}`;
            document.getElementById(`selectedDetails${index}`).textContent = `Rating: ${player.rating} | Robustness: ${player.robustness} | ${player.location || 'Location unknown'}`;
            document.getElementById(`selectedPlayer${index}`).classList.add('visible');
            updateCombinedRating();
            validateForm();
        }

        function selectNotInSystem(index) {
            const searchInput = document.getElementById(`searchInput${index}`);
            const name = searchInput.value.trim();
            if (!name) { showAlert('error', 'Please enter the player name before selecting "Not in system"'); return; }
            playerSelections[index] = { fargoId: null, readableId: null, name: name, rating: 'N/A', robustness: 'N/A', location: null, inSystem: false };
            document.getElementById(`searchResults${index}`).classList.remove('visible');
            document.getElementById(`selectedName${index}`).textContent = `✓ ${name}`;
            document.getElementById(`selectedDetails${index}`).textContent = 'Not in Fargo system';
            document.getElementById(`selectedPlayer${index}`).classList.add('visible');
            updateCombinedRating();
            validateForm();
        }

        function clearPlayerSelection(index) {
            playerSelections[index] = null;
            document.getElementById(`searchInput${index}`).value = '';
            document.getElementById(`searchResults${index}`).classList.remove('visible');
            document.getElementById(`selectedPlayer${index}`).classList.remove('visible');
            updateCombinedRating();
            validateForm();
        }

        function updateCombinedRating() {
            if (!selectedTournament.ratingCap || selectedTournament.teamSize <= 1) return;
            let total = 0, hasUnratedPlayer = false;
            for (const player of playerSelections) { if (player) { if (player.inSystem) total += parseInt(player.rating) || 0; else hasUnratedPlayer = true; } }
            const ratingValueEl = document.getElementById('combinedRatingValue');
            const capStatusEl = document.getElementById('capStatus');
            const displayEl = document.getElementById('combinedRatingDisplay');
            ratingValueEl.textContent = hasUnratedPlayer ? `${total}+` : total;
            const cap = parseInt(selectedTournament.ratingCap);
            const isOverCap = total > cap;
            if (isOverCap) { ratingValueEl.classList.add('over-cap'); capStatusEl.className = 'cap-status over'; capStatusEl.textContent = 'Over Cap'; displayEl.classList.add('over-cap'); }
            else { ratingValueEl.classList.remove('over-cap'); capStatusEl.className = 'cap-status under'; capStatusEl.textContent = hasUnratedPlayer ? 'Under Cap*' : 'Under Cap'; displayEl.classList.remove('over-cap'); }
        }

        function isOverRatingCap() {
            if (!selectedTournament.ratingCap || selectedTournament.teamSize <= 1) return false;
            let total = 0;
            for (const player of playerSelections) { if (player && player.inSystem) total += parseInt(player.rating) || 0; }
            return total > parseInt(selectedTournament.ratingCap);
        }

        function setupPhoneValidation(inputId, validationId) {
            const input = document.getElementById(inputId);
            const validation = document.getElementById(validationId);
            if (!input) return;
            input.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 0) {
                    if (value.length <= 3) value = `(${value}`;
                    else if (value.length <= 6) value = `(${value.slice(0,3)}) ${value.slice(3)}`;
                    else value = `(${value.slice(0,3)}) ${value.slice(3,6)}-${value.slice(6,10)}`;
                }
                e.target.value = value;
                const digits = value.replace(/\D/g, '');
                if (digits.length === 10) { validation.textContent = '✓ Valid phone number'; validation.className = 'phone-validation valid'; }
                else if (digits.length > 0) { validation.textContent = 'Please enter a 10-digit phone number'; validation.className = 'phone-validation invalid'; }
                else { validation.textContent = ''; validation.className = 'phone-validation'; }
                validateForm();
            });
        }

        function isPhoneValid(inputId) { const input = document.getElementById(inputId); if (!input) return true; return input.value.replace(/\D/g, '').length === 10; }

        function validateForm() {
            const submitBtn = document.getElementById('submitBtn');
            let isValid = true;
            if (playerSelections.some(p => p === null)) isValid = false;
            if (selectedTournament.teamSize > 1) { if (!document.getElementById('teamName').value.trim()) isValid = false; if (!isPhoneValid('captainPhone')) isValid = false; }
            else { if (!isPhoneValid('playerPhone0')) isValid = false; }
            if (isOverRatingCap()) isValid = false;
            submitBtn.disabled = !isValid;
        }

        async function lookupRegistration() {
            const phoneInput = document.getElementById('lookupPhone');
            const phone = phoneInput.value.replace(/\D/g, '');
            if (phone.length !== 10) { showAlert('error', 'Please enter a valid 10-digit phone number'); return; }
            try {
                const url = `${GOOGLE_SCRIPT_URL}?action=lookupRegistration&tournament=${encodeURIComponent(selectedTournament.name)}&phone=${phone}`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.success && data.registration) enterEditMode(data.registration);
                else showAlert('error', data.error || 'No registration found for this phone number');
            } catch (error) { console.error('Lookup error:', error); showAlert('error', 'Failed to look up registration. Please try again.'); }
        }

        function enterEditMode(registration) {
            isEditMode = true;
            editRowIndex = registration.rowIndex;
            document.getElementById('editModeSection').classList.add('editing');
            document.getElementById('editBadge').style.display = 'inline';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = 'Update Registration';
            submitBtn.classList.add('update-mode');
            if (selectedTournament.teamSize > 1) { document.getElementById('teamName').value = registration.teamName || ''; document.getElementById('captainPhone').value = formatPhoneForDisplay(registration.phone); }
            else { document.getElementById('playerPhone0').value = formatPhoneForDisplay(registration.phone); }
            for (let i = 0; i < registration.players.length && i < playerSelections.length; i++) {
                const player = registration.players[i];
                const isInSystem = player.fargoId && player.fargoId !== 'Not in system';
                playerSelections[i] = { fargoId: isInSystem ? player.fargoId : null, readableId: null, name: player.name, rating: player.rating, robustness: player.robustness, inSystem: isInSystem };
                document.getElementById(`selectedName${i}`).textContent = `✓ ${player.name}`;
                document.getElementById(`selectedDetails${i}`).textContent = isInSystem ? `Rating: ${player.rating} | Robustness: ${player.robustness}` : 'Not in Fargo system';
                document.getElementById(`selectedPlayer${i}`).classList.add('visible');
            }
            updateCombinedRating();
            validateForm();
            showAlert('success', 'Registration loaded. Make your changes and click "Update Registration".');
        }

        function cancelEditMode() {
            isEditMode = false;
            editRowIndex = null;
            document.getElementById('editModeSection').classList.remove('editing');
            document.getElementById('editBadge').style.display = 'none';
            document.getElementById('cancelEditBtn').style.display = 'none';
            document.getElementById('lookupPhone').value = '';
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = 'Complete Registration';
            submitBtn.classList.remove('update-mode');
            if (selectedTournament) buildRegistrationForm();
        }

        function formatPhoneForDisplay(phone) {
            if (!phone) return '';
            const digits = phone.replace(/\D/g, '').slice(-10);
            if (digits.length === 10) return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
            return phone;
        }

        function extractFacebookName(url) {
            if (!url) return 'Sponsor';
            try {
                // Remove trailing slashes and query params
                let cleanUrl = url.split('?')[0].replace(/\/+$/, '');
                
                // Extract the last part of the path
                let parts = cleanUrl.split('/');
                let name = parts[parts.length - 1];
                
                // Handle profile.php?id=xxx format
                if (name === 'profile.php' || !name) {
                    return 'Sponsor';
                }
                
                // Remove common prefixes
                name = name.replace(/^(pages\/|pg\/|groups\/)/, '');
                
                // Convert URL-style names to readable format
                // "JoesPoolHall" -> "Joes Pool Hall"
                // "joes-pool-hall" -> "Joes Pool Hall"
                // "joes.pool.hall" -> "Joes Pool Hall"
                
                // Replace dots and hyphens with spaces
                name = name.replace(/[.\-_]/g, ' ');
                
                // Add spaces before capital letters (camelCase)
                name = name.replace(/([a-z])([A-Z])/g, '$1 $2');
                
                // Capitalize first letter of each word
                name = name.split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                    .join(' ')
                    .trim();
                
                return name || 'Sponsor';
            } catch (e) {
                return 'Sponsor';
            }
        }

        async function submitRegistration() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span> ' + (isEditMode ? 'Updating...' : 'Submitting...');
            const t = selectedTournament;
            let registrationData = { tournamentId: t.id, tournamentName: t.name, timestamp: new Date().toISOString() };
            if (isEditMode) { registrationData.action = 'edit'; registrationData.rowIndex = editRowIndex; }
            if (t.teamSize > 1) { registrationData.teamName = document.getElementById('teamName').value.trim(); registrationData.captainPhone = '+1' + document.getElementById('captainPhone').value.replace(/\D/g, ''); }
            else { registrationData.phone = '+1' + document.getElementById('playerPhone0').value.replace(/\D/g, ''); }
            registrationData.players = playerSelections.map(p => ({ name: p.name, fargoId: p.fargoId, readableId: p.readableId, rating: p.rating, robustness: p.robustness, inSystem: p.inSystem }));
            try {
                await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(registrationData) });
                const message = isEditMode ? `Registration updated! ${t.teamSize > 1 ? registrationData.teamName : registrationData.players[0].name}'s registration for ${t.name} has been updated.` : `Registration successful! ${t.teamSize > 1 ? registrationData.teamName : registrationData.players[0].name} has been registered for ${t.name}.`;
                showAlert('success', message);
                resetForm();
            } catch (error) { console.error('Submission error:', error); showAlert('error', 'Registration failed. Please try again or contact the tournament organizer.'); }
            submitBtn.disabled = false;
            submitBtn.innerHTML = isEditMode ? 'Update Registration' : 'Complete Registration';
        }

        function resetForm() { document.getElementById('tournamentSelect').value = ''; isEditMode = false; editRowIndex = null; hideTournamentInfo(); }

        function showAlert(type, message) {
            const alertEl = document.getElementById(type === 'success' ? 'alertSuccess' : 'alertError');
            alertEl.textContent = message;
            alertEl.classList.add('visible');
            setTimeout(() => { alertEl.classList.remove('visible'); }, 6000);
        }
    </script>
</body>
</html>
