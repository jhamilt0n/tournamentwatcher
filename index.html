<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Registration</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-input: #1a1a25;
            --accent-gold: #d4af37;
            --accent-gold-dim: #b8962e;
            --accent-green: #2ecc71;
            --accent-red: #e74c3c;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a8;
            --text-muted: #606068;
            --border-color: #2a2a35;
            --border-focus: #d4af37;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans 3', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Image */
        .header-image {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .header-placeholder {
            width: 100%;
            aspect-ratio: 16/9;
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-input) 100%);
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 1.2rem;
        }

        /* Tournament Selection */
        .tournament-select-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            letter-spacing: 2px;
            color: var(--accent-gold);
            margin-bottom: 20px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.15);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23a0a0a8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 44px;
        }

        .form-select option {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        /* Tournament Info Display */
        .tournament-info {
            display: none;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .tournament-info.visible {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tournament-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            letter-spacing: 3px;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .info-item {
            background: var(--bg-input);
            padding: 15px;
            border-radius: 8px;
        }

        .info-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .info-value.highlight {
            color: var(--accent-gold);
        }

        .rules-section {
            background: var(--bg-input);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .rules-title {
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 10px;
        }

        .rules-text {
            color: var(--text-secondary);
            white-space: pre-wrap;
        }

        .sponsors-section {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .sponsor-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #1877f2;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .sponsor-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(24, 119, 242, 0.4);
        }

        .sponsor-link svg {
            width: 18px;
            height: 18px;
        }

        /* Registration Form */
        .registration-form {
            display: none;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .registration-form.visible {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        .team-info-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
        }

        /* Player Search */
        .player-section {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .player-header {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 2px;
            color: var(--accent-gold);
            margin-bottom: 20px;
        }

        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-input {
            flex: 1;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-search {
            background: var(--accent-gold);
            color: var(--bg-dark);
        }

        .btn-search:hover {
            background: var(--accent-gold-dim);
            transform: translateY(-1px);
        }

        .btn-search:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }

        .btn-clear {
            background: transparent;
            border: 2px solid var(--accent-red);
            color: var(--accent-red);
            padding: 12px 20px;
        }

        .btn-clear:hover {
            background: var(--accent-red);
            color: white;
        }

        /* Search Results */
        .search-results {
            display: none;
            margin-top: 15px;
        }

        .search-results.visible {
            display: block;
        }

        .search-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .search-status.loading {
            background: rgba(212, 175, 55, 0.1);
            color: var(--accent-gold);
        }

        .search-status.error {
            background: rgba(231, 76, 60, 0.1);
            color: var(--accent-red);
        }

        .search-status.no-results {
            background: rgba(160, 160, 168, 0.1);
            color: var(--text-secondary);
        }

        .results-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .result-item:hover {
            border-color: var(--accent-gold);
            transform: translateX(5px);
        }

        .result-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .result-item.disabled:hover {
            border-color: var(--accent-red);
            transform: none;
        }

        .result-info {
            flex: 1;
        }

        .result-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 3px;
        }

        .result-location {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .result-stats {
            text-align: right;
        }

        .result-rating {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--accent-gold);
        }

        .result-robustness {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .result-robustness.insufficient {
            color: var(--accent-red);
        }

        .not-in-system-btn {
            width: 100%;
            padding: 15px;
            background: transparent;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 10px;
        }

        .not-in-system-btn:hover {
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }

        .not-in-system-btn.hidden {
            display: none;
        }

        /* Selected Player Display */
        .selected-player {
            display: none;
            background: rgba(46, 204, 113, 0.1);
            border: 2px solid var(--accent-green);
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
        }

        .selected-player.visible {
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .selected-player-info h4 {
            color: var(--accent-green);
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .selected-player-info p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Phone Input */
        .phone-input-wrapper {
            position: relative;
        }

        .phone-prefix {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-weight: 600;
        }

        .phone-input {
            padding-left: 50px;
        }

        .phone-validation {
            margin-top: 8px;
            font-size: 0.85rem;
        }

        .phone-validation.valid {
            color: var(--accent-green);
        }

        .phone-validation.invalid {
            color: var(--accent-red);
        }

        /* Submit Button */
        .submit-section {
            margin-top: 30px;
        }

        .btn-submit {
            width: 100%;
            padding: 18px 30px;
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-dim) 100%);
            color: var(--bg-dark);
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 3px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
        }

        .btn-submit:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(212, 175, 55, 0.4);
        }

        .btn-submit:disabled {
            background: var(--text-muted);
            box-shadow: none;
            cursor: not-allowed;
        }

        /* Alert Messages */
        .alert {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .alert-success {
            background: rgba(46, 204, 113, 0.15);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
        }

        .alert-error {
            background: rgba(231, 76, 60, 0.15);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
        }

        /* Robustness Warning */
        .robustness-warning {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid var(--accent-red);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: var(--accent-red);
            font-weight: 500;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(212, 175, 55, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-gold);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }

            .tournament-name {
                font-size: 1.8rem;
            }

            .search-container {
                flex-direction: column;
            }

            .btn-search {
                width: 100%;
            }

            .result-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .result-stats {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Image -->
        <div id="headerContainer">
            <div class="header-placeholder">Select a tournament to begin</div>
        </div>

        <!-- Tournament Selection -->
        <section class="tournament-select-section">
            <h2 class="section-title">Select Tournament</h2>
            <div class="form-group">
                <label class="form-label" for="tournamentSelect">Choose a Tournament</label>
                <select class="form-select" id="tournamentSelect">
                    <option value="">-- Select a Tournament --</option>
                </select>
            </div>
        </section>

        <!-- Alert Messages -->
        <div id="alertSuccess" class="alert alert-success"></div>
        <div id="alertError" class="alert alert-error"></div>

        <!-- Tournament Info -->
        <section id="tournamentInfo" class="tournament-info">
            <h1 id="tournamentName" class="tournament-name"></h1>
            
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Date</div>
                    <div class="info-value" id="infoDate"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Doors Open</div>
                    <div class="info-value" id="infoDoorsOpen"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Play Begins</div>
                    <div class="info-value" id="infoPlayBegins"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Location</div>
                    <div class="info-value" id="infoLocation"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Entry Fee</div>
                    <div class="info-value highlight" id="infoEntryFee"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Race To</div>
                    <div class="info-value" id="infoRace"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Table Size</div>
                    <div class="info-value" id="infoTableSize"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Table Type</div>
                    <div class="info-value" id="infoTableType"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Table Fees</div>
                    <div class="info-value" id="infoTableFees"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Format</div>
                    <div class="info-value" id="infoFormat"></div>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-item" id="auctionItem" style="display:none;">
                    <div class="info-label">Player Auction</div>
                    <div class="info-value highlight">Yes</div>
                </div>
                <div class="info-item" id="sidepotItem" style="display:none;">
                    <div class="info-label">Sidepot</div>
                    <div class="info-value highlight">Yes</div>
                </div>
                <div class="info-item" id="addedMoneyItem" style="display:none;">
                    <div class="info-label">Added Money</div>
                    <div class="info-value highlight" id="infoAddedMoney"></div>
                </div>
                <div class="info-item" id="maxPlayersItem" style="display:none;">
                    <div class="info-label">Max Entries</div>
                    <div class="info-value" id="infoMaxPlayers"></div>
                </div>
                <div class="info-item" id="robustnessItem" style="display:none;">
                    <div class="info-label">Min Robustness Required</div>
                    <div class="info-value highlight" id="infoRobustness"></div>
                </div>
            </div>

            <div id="rulesSection" class="rules-section" style="display:none;">
                <div class="rules-title">Tournament Rules</div>
                <div class="rules-text" id="infoRules"></div>
            </div>

            <div id="sponsorsSection" class="sponsors-section" style="display:none;"></div>
        </section>

        <!-- Registration Form -->
        <section id="registrationForm" class="registration-form">
            <h2 class="section-title">Registration</h2>

            <div id="robustnessWarning" class="robustness-warning" style="display:none;">
                ⚠️ This tournament requires a minimum Fargo robustness of <span id="requiredRobustness"></span>. Players not meeting this requirement cannot register.
            </div>

            <!-- Team Info (for 2+ players) -->
            <div id="teamInfoSection" class="team-info-section" style="display:none;">
                <div class="form-group">
                    <label class="form-label" for="teamName">Team Name</label>
                    <input type="text" class="form-input" id="teamName" placeholder="Enter your team name">
                </div>
                <div class="form-group">
                    <label class="form-label" for="captainPhone">Captain's Phone Number</label>
                    <div class="phone-input-wrapper">
                        <span class="phone-prefix">+1</span>
                        <input type="tel" class="form-input phone-input" id="captainPhone" placeholder="(555) 123-4567" maxlength="14">
                    </div>
                    <div id="captainPhoneValidation" class="phone-validation"></div>
                </div>
            </div>

            <!-- Player Sections (dynamically generated) -->
            <div id="playerSections"></div>

            <!-- Submit Button -->
            <div class="submit-section">
                <button type="button" class="btn btn-submit" id="submitBtn" disabled>
                    Complete Registration
                </button>
            </div>
        </section>
    </div>

    <script>
        // =====================
        // CONFIGURATION
        // =====================
        // Replace this URL with your deployed Google Apps Script Web App URL
        const GOOGLE_SCRIPT_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE';
        const FARGO_API_URL = 'https://dashboard.fargorate.com/api/indexsearch';

        // =====================
        // STATE
        // =====================
        let tournaments = [];
        let selectedTournament = null;
        let playerSelections = [];

        // =====================
        // INITIALIZATION
        // =====================
        document.addEventListener('DOMContentLoaded', () => {
            loadTournaments();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('tournamentSelect').addEventListener('change', onTournamentChange);
            document.getElementById('submitBtn').addEventListener('click', submitRegistration);
        }

        // =====================
        // TOURNAMENT LOADING
        // =====================
        async function loadTournaments() {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getTournaments`);
                const data = await response.json();
                
                if (data.success) {
                    tournaments = data.tournaments;
                    populateTournamentDropdown();
                } else {
                    showAlert('error', 'Failed to load tournaments. Please refresh the page.');
                }
            } catch (error) {
                console.error('Error loading tournaments:', error);
                showAlert('error', 'Failed to load tournaments. Please check your connection and refresh.');
            }
        }

        function populateTournamentDropdown() {
            const select = document.getElementById('tournamentSelect');
            tournaments.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = `${t.name} - ${t.date}`;
                select.appendChild(option);
            });
        }

        function onTournamentChange(e) {
            const tournamentId = e.target.value;
            
            if (!tournamentId) {
                hideTournamentInfo();
                return;
            }

            selectedTournament = tournaments.find(t => t.id === tournamentId);
            if (selectedTournament) {
                displayTournamentInfo();
                buildRegistrationForm();
            }
        }

        // =====================
        // TOURNAMENT INFO DISPLAY
        // =====================
        function displayTournamentInfo() {
            const t = selectedTournament;

            // Update header image
            const headerContainer = document.getElementById('headerContainer');
            if (t.headerImage) {
                headerContainer.innerHTML = `<img src="${t.headerImage}" alt="${t.name}" class="header-image">`;
            } else {
                headerContainer.innerHTML = `<div class="header-placeholder">${t.name}</div>`;
            }

            // Basic info
            document.getElementById('tournamentName').textContent = t.name;
            document.getElementById('infoDate').textContent = t.date;
            document.getElementById('infoDoorsOpen').textContent = t.doorsOpen || 'TBD';
            document.getElementById('infoPlayBegins').textContent = t.playBegins || 'TBD';
            document.getElementById('infoLocation').textContent = t.location;
            document.getElementById('infoEntryFee').textContent = t.entryFee;
            document.getElementById('infoRace').textContent = t.race;
            document.getElementById('infoTableSize').textContent = t.tableSize;
            document.getElementById('infoTableType').textContent = t.tableType;
            document.getElementById('infoTableFees').textContent = t.tableFees;
            document.getElementById('infoFormat').textContent = t.formatDescription || `${t.teamSize} Player${t.teamSize > 1 ? 's' : ''}`;

            // Optional info items
            toggleInfoItem('auctionItem', t.playerAuction);
            toggleInfoItem('sidepotItem', t.sidepot);
            
            if (t.addedMoney) {
                document.getElementById('addedMoneyItem').style.display = 'block';
                document.getElementById('infoAddedMoney').textContent = t.addedMoneyStructure || 'Yes';
            } else {
                document.getElementById('addedMoneyItem').style.display = 'none';
            }

            if (t.maxPlayers) {
                document.getElementById('maxPlayersItem').style.display = 'block';
                document.getElementById('infoMaxPlayers').textContent = t.maxPlayers;
            } else {
                document.getElementById('maxPlayersItem').style.display = 'none';
            }

            if (t.robustnessRequirement) {
                document.getElementById('robustnessItem').style.display = 'block';
                document.getElementById('infoRobustness').textContent = t.robustnessRequirement;
            } else {
                document.getElementById('robustnessItem').style.display = 'none';
            }

            // Rules
            if (t.rules) {
                document.getElementById('rulesSection').style.display = 'block';
                document.getElementById('infoRules').textContent = t.rules;
            } else {
                document.getElementById('rulesSection').style.display = 'none';
            }

            // Sponsors
            const sponsorsSection = document.getElementById('sponsorsSection');
            if (t.sponsorLinks && t.sponsorLinks.length > 0) {
                sponsorsSection.style.display = 'flex';
                sponsorsSection.innerHTML = t.sponsorLinks.map((link, i) => `
                    <a href="${link}" target="_blank" class="sponsor-link">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                        Sponsor ${t.sponsorLinks.length > 1 ? i + 1 : ''}
                    </a>
                `).join('');
            } else {
                sponsorsSection.style.display = 'none';
            }

            document.getElementById('tournamentInfo').classList.add('visible');
        }

        function toggleInfoItem(id, show) {
            document.getElementById(id).style.display = show ? 'block' : 'none';
        }

        function hideTournamentInfo() {
            document.getElementById('tournamentInfo').classList.remove('visible');
            document.getElementById('registrationForm').classList.remove('visible');
            document.getElementById('headerContainer').innerHTML = '<div class="header-placeholder">Select a tournament to begin</div>';
            selectedTournament = null;
        }

        // =====================
        // REGISTRATION FORM BUILDING
        // =====================
        function buildRegistrationForm() {
            const t = selectedTournament;
            playerSelections = new Array(t.teamSize).fill(null);

            // Show/hide robustness warning
            const warningEl = document.getElementById('robustnessWarning');
            if (t.robustnessRequirement) {
                warningEl.style.display = 'block';
                document.getElementById('requiredRobustness').textContent = t.robustnessRequirement;
            } else {
                warningEl.style.display = 'none';
            }

            // Show/hide team info section
            const teamSection = document.getElementById('teamInfoSection');
            if (t.teamSize > 1) {
                teamSection.style.display = 'block';
                document.getElementById('teamName').value = '';
                document.getElementById('captainPhone').value = '';
                document.getElementById('captainPhoneValidation').textContent = '';
                setupPhoneValidation('captainPhone', 'captainPhoneValidation');
            } else {
                teamSection.style.display = 'none';
            }

            // Build player sections
            const playerSectionsEl = document.getElementById('playerSections');
            playerSectionsEl.innerHTML = '';

            for (let i = 0; i < t.teamSize; i++) {
                const playerSection = createPlayerSection(i, t.teamSize === 1);
                playerSectionsEl.appendChild(playerSection);
            }

            document.getElementById('registrationForm').classList.add('visible');
            validateForm();
        }

        function createPlayerSection(index, isSingle) {
            const section = document.createElement('div');
            section.className = 'player-section';
            section.id = `playerSection${index}`;

            const title = isSingle ? 'Player Information' : `Player ${index + 1}`;
            const phoneHtml = isSingle ? `
                <div class="form-group" style="margin-top: 20px;">
                    <label class="form-label" for="playerPhone${index}">Phone Number</label>
                    <div class="phone-input-wrapper">
                        <span class="phone-prefix">+1</span>
                        <input type="tel" class="form-input phone-input" id="playerPhone${index}" placeholder="(555) 123-4567" maxlength="14">
                    </div>
                    <div id="playerPhoneValidation${index}" class="phone-validation"></div>
                </div>
            ` : '';

            section.innerHTML = `
                <h3 class="player-header">${title}</h3>
                <div class="search-container">
                    <input type="text" class="form-input search-input" id="searchInput${index}" placeholder="Enter player name to search Fargo database">
                    <button type="button" class="btn btn-search" id="searchBtn${index}">Search</button>
                </div>
                <div class="search-results" id="searchResults${index}">
                    <div class="search-status" id="searchStatus${index}"></div>
                    <div class="results-list" id="resultsList${index}"></div>
                    <button type="button" class="not-in-system-btn hidden" id="notInSystemBtn${index}">
                        Player not in Fargo system - Enter name manually
                    </button>
                </div>
                <div class="selected-player" id="selectedPlayer${index}">
                    <div class="selected-player-info">
                        <h4 id="selectedName${index}"></h4>
                        <p id="selectedDetails${index}"></p>
                    </div>
                    <button type="button" class="btn btn-clear" id="clearBtn${index}">Change</button>
                </div>
                ${phoneHtml}
            `;

            // Setup event listeners after adding to DOM
            setTimeout(() => {
                const searchInput = document.getElementById(`searchInput${index}`);
                const searchBtn = document.getElementById(`searchBtn${index}`);
                const clearBtn = document.getElementById(`clearBtn${index}`);
                const notInSystemBtn = document.getElementById(`notInSystemBtn${index}`);

                searchBtn.addEventListener('click', () => searchPlayer(index));
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') searchPlayer(index);
                });
                clearBtn.addEventListener('click', () => clearPlayerSelection(index));
                notInSystemBtn.addEventListener('click', () => selectNotInSystem(index));

                if (isSingle) {
                    setupPhoneValidation(`playerPhone${index}`, `playerPhoneValidation${index}`);
                }
            }, 0);

            return section;
        }

        // =====================
        // PLAYER SEARCH
        // =====================
        async function searchPlayer(index) {
            const searchInput = document.getElementById(`searchInput${index}`);
            const searchResults = document.getElementById(`searchResults${index}`);
            const searchStatus = document.getElementById(`searchStatus${index}`);
            const resultsList = document.getElementById(`resultsList${index}`);
            const notInSystemBtn = document.getElementById(`notInSystemBtn${index}`);
            const searchBtn = document.getElementById(`searchBtn${index}`);

            const query = searchInput.value.trim();
            if (!query) return;

            // Show loading state
            searchResults.classList.add('visible');
            searchStatus.className = 'search-status loading';
            searchStatus.innerHTML = '<span class="spinner"></span> Searching Fargo database...';
            resultsList.innerHTML = '';
            notInSystemBtn.classList.add('hidden');
            searchBtn.disabled = true;

            try {
                const response = await fetch(`${FARGO_API_URL}?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                searchBtn.disabled = false;

                if (data.value && data.value.length > 0) {
                    searchStatus.style.display = 'none';
                    displaySearchResults(index, data.value);
                } else {
                    searchStatus.className = 'search-status no-results';
                    searchStatus.textContent = `No players found matching "${query}". Try a different spelling or nickname.`;
                    
                    // Show "not in system" button only if no robustness requirement
                    if (!selectedTournament.robustnessRequirement) {
                        notInSystemBtn.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Search error:', error);
                searchBtn.disabled = false;
                searchStatus.className = 'search-status error';
                searchStatus.textContent = 'Search failed. Please try again.';
            }
        }

        function displaySearchResults(index, players) {
            const resultsList = document.getElementById(`resultsList${index}`);
            const notInSystemBtn = document.getElementById(`notInSystemBtn${index}`);
            const robustnessReq = selectedTournament.robustnessRequirement;

            resultsList.innerHTML = players.map(player => {
                const meetsRobustness = !robustnessReq || parseInt(player.robustness) >= parseInt(robustnessReq);
                const robustnessClass = meetsRobustness ? '' : 'insufficient';
                const itemClass = meetsRobustness ? '' : 'disabled';
                
                return `
                    <div class="result-item ${itemClass}" 
                         onclick="${meetsRobustness ? `selectPlayer(${index}, ${JSON.stringify(player).replace(/"/g, '&quot;')})` : ''}"
                         title="${meetsRobustness ? 'Click to select' : 'Does not meet robustness requirement'}">
                        <div class="result-info">
                            <div class="result-name">${player.firstName} ${player.lastName}</div>
                            <div class="result-location">${player.location || 'Location unknown'}</div>
                        </div>
                        <div class="result-stats">
                            <div class="result-rating">${player.rating}</div>
                            <div class="result-robustness ${robustnessClass}">Robustness: ${player.robustness}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Show "not in system" button only if no robustness requirement
            if (!robustnessReq) {
                notInSystemBtn.classList.remove('hidden');
            }
        }

        function selectPlayer(index, player) {
            playerSelections[index] = {
                fargoId: player.id,
                readableId: player.readableId,
                name: `${player.firstName} ${player.lastName}`,
                rating: player.rating,
                robustness: player.robustness,
                location: player.location,
                inSystem: true
            };

            // Update UI
            const searchResults = document.getElementById(`searchResults${index}`);
            const selectedPlayer = document.getElementById(`selectedPlayer${index}`);
            const selectedName = document.getElementById(`selectedName${index}`);
            const selectedDetails = document.getElementById(`selectedDetails${index}`);

            searchResults.classList.remove('visible');
            selectedName.textContent = `✓ ${player.firstName} ${player.lastName}`;
            selectedDetails.textContent = `Rating: ${player.rating} | Robustness: ${player.robustness} | ${player.location || 'Location unknown'}`;
            selectedPlayer.classList.add('visible');

            validateForm();
        }

        function selectNotInSystem(index) {
            const searchInput = document.getElementById(`searchInput${index}`);
            const name = searchInput.value.trim();

            if (!name) {
                showAlert('error', 'Please enter the player name before selecting "Not in system"');
                return;
            }

            playerSelections[index] = {
                fargoId: null,
                readableId: null,
                name: name,
                rating: 'N/A',
                robustness: 'N/A',
                location: null,
                inSystem: false
            };

            // Update UI
            const searchResults = document.getElementById(`searchResults${index}`);
            const selectedPlayer = document.getElementById(`selectedPlayer${index}`);
            const selectedName = document.getElementById(`selectedName${index}`);
            const selectedDetails = document.getElementById(`selectedDetails${index}`);

            searchResults.classList.remove('visible');
            selectedName.textContent = `✓ ${name}`;
            selectedDetails.textContent = 'Not in Fargo system';
            selectedPlayer.classList.add('visible');

            validateForm();
        }

        function clearPlayerSelection(index) {
            playerSelections[index] = null;

            const searchInput = document.getElementById(`searchInput${index}`);
            const searchResults = document.getElementById(`searchResults${index}`);
            const selectedPlayer = document.getElementById(`selectedPlayer${index}`);

            searchInput.value = '';
            searchResults.classList.remove('visible');
            selectedPlayer.classList.remove('visible');

            validateForm();
        }

        // =====================
        // PHONE VALIDATION
        // =====================
        function setupPhoneValidation(inputId, validationId) {
            const input = document.getElementById(inputId);
            const validation = document.getElementById(validationId);

            if (!input) return;

            input.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                
                // Format as (XXX) XXX-XXXX
                if (value.length > 0) {
                    if (value.length <= 3) {
                        value = `(${value}`;
                    } else if (value.length <= 6) {
                        value = `(${value.slice(0,3)}) ${value.slice(3)}`;
                    } else {
                        value = `(${value.slice(0,3)}) ${value.slice(3,6)}-${value.slice(6,10)}`;
                    }
                }
                
                e.target.value = value;

                // Validate
                const digits = value.replace(/\D/g, '');
                if (digits.length === 10) {
                    validation.textContent = '✓ Valid phone number';
                    validation.className = 'phone-validation valid';
                } else if (digits.length > 0) {
                    validation.textContent = 'Please enter a 10-digit phone number';
                    validation.className = 'phone-validation invalid';
                } else {
                    validation.textContent = '';
                    validation.className = 'phone-validation';
                }

                validateForm();
            });
        }

        function isPhoneValid(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return true;
            const digits = input.value.replace(/\D/g, '');
            return digits.length === 10;
        }

        // =====================
        // FORM VALIDATION
        // =====================
        function validateForm() {
            const submitBtn = document.getElementById('submitBtn');
            let isValid = true;

            // Check all players selected
            if (playerSelections.some(p => p === null)) {
                isValid = false;
            }

            // Check team name and captain phone for team events
            if (selectedTournament.teamSize > 1) {
                if (!document.getElementById('teamName').value.trim()) {
                    isValid = false;
                }
                if (!isPhoneValid('captainPhone')) {
                    isValid = false;
                }
            } else {
                // Check player phone for singles
                if (!isPhoneValid('playerPhone0')) {
                    isValid = false;
                }
            }

            submitBtn.disabled = !isValid;
        }

        // =====================
        // FORM SUBMISSION
        // =====================
        async function submitRegistration() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span> Submitting...';

            const t = selectedTournament;
            let registrationData = {
                tournamentId: t.id,
                tournamentName: t.name,
                timestamp: new Date().toISOString()
            };

            if (t.teamSize > 1) {
                registrationData.teamName = document.getElementById('teamName').value.trim();
                registrationData.captainPhone = '+1' + document.getElementById('captainPhone').value.replace(/\D/g, '');
            } else {
                registrationData.phone = '+1' + document.getElementById('playerPhone0').value.replace(/\D/g, '');
            }

            registrationData.players = playerSelections.map(p => ({
                name: p.name,
                fargoId: p.fargoId,
                readableId: p.readableId,
                rating: p.rating,
                robustness: p.robustness,
                inSystem: p.inSystem
            }));

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(registrationData)
                });

                showAlert('success', `Registration successful! ${t.teamSize > 1 ? registrationData.teamName : registrationData.players[0].name} has been registered for ${t.name}.`);
                
                // Reset form
                resetForm();
            } catch (error) {
                console.error('Submission error:', error);
                showAlert('error', 'Registration failed. Please try again or contact the tournament organizer.');
            }

            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Complete Registration';
        }

        function resetForm() {
            document.getElementById('tournamentSelect').value = '';
            hideTournamentInfo();
        }

        // =====================
        // ALERTS
        // =====================
        function showAlert(type, message) {
            const alertEl = document.getElementById(type === 'success' ? 'alertSuccess' : 'alertError');
            alertEl.textContent = message;
            alertEl.classList.add('visible');

            setTimeout(() => {
                alertEl.classList.remove('visible');
            }, 5000);
        }
    </script>
</body>
</html>
